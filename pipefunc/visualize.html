<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Graph</title>

    <script src="https://unpkg.com/jquery@3.6.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mountainstorm/jquery.graphviz.svg@master/js/jquery.graphviz.svg.js"></script>
    <script src="https://d3js.org/d3.v7.6.1.min.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm@1.18.0/dist/index.min.js"></script>
    <script src="https://unpkg.com/d3-graphviz@4.4.0/build/d3-graphviz.min.js"></script>
</head>

<body>
    <div id="graph" style="text-align: center;"></div>
    <script>
        const currentHighlight = $();
        /** graphviz globals **/
        // creates a d3-graphviz renderer instance, not to be confused with jquery.graphviz.svg
        var graphviz = d3.select("#graph").graphviz();
        // object for saving configuration from the extension
        var viewConfig;

        // currently selected graphviz render engine
        var selectedEngine = "dot";

        // Object for saving the current GraphVizSVG Object
        var gv;

        // SearchObject which holds the current Search Settings
        const searchObject = {
            type: "included",
            case: "insensitive",
            direction: "bidirectional",
            nodeName: true,
            nodeLabel: true,
            edgeLabel: true,
            clusterName: true,
            clusterLabel: true,
        }

        // Array with the current Selections
        var currentSelection = [];

        function highlight() {
            let highlightedNodes = $();
            for (const selection of currentSelection) {
                const nodes = getAffectedNodes(selection.set, selection.direction);
                highlightedNodes = highlightedNodes.add(nodes);
            }

            gv.highlight(highlightedNodes, true);
            //gv.bringToFront(highlightedNodes);
        }

        // start from highlighting.js
        function getAffectedNodes($set, $mode = "bidirectional") {
            $result = $().add($set);
            if ($mode === "bidirectional" || $mode === "downstream") {
                $set.each((i, el) => {
                    if (el.className.baseVal === "edge") {
                        const edge = $(el).data("name");
                        const nodes = gv.nodesByName();
                        const downStreamNode = edge.split("->")[1];
                        if (downStreamNode) {
                            $result.push(nodes[downStreamNode]);
                            $result = $result.add(gv.linkedFrom(nodes[downStreamNode], true));
                        }
                    } else {
                        $result = $result.add(gv.linkedFrom(el, true));
                    }
                });
            }
            if ($mode === "bidirectional" || $mode === "upstream") {
                $set.each((i, el) => {
                    if (el.className.baseVal === "edge") {
                        const edge = $(el).data("name");
                        const nodes = gv.nodesByName();
                        const upStreamNode = edge.split("->")[0];
                        if (upStreamNode) {
                            $result.push(nodes[upStreamNode]);
                            $result = $result.add(gv.linkedTo(nodes[upStreamNode], true));
                        }
                    } else {
                        $result = $result.add(gv.linkedTo(el, true));
                    }
                });
            }
            return $result;
        }
        // end from highlighting.js

        function reset() {
            graphviz.resetZoom();
            gv.highlight(); // reset node selection on reset
            currentSelection = [];
        }

        function changeDirection(newDirection) {
            searchObject.direction = newDirection;
        }

        function changeEngine(newEngine) {
            selectedEngine = newEngine;
        }

        /** main render funcs **/
        function render(dotSrc) {
            transition = d3.transition("startTransition")
                .ease(d3.easeLinear)
                .delay(viewConfig.transitionDelay)
                .duration(viewConfig.transitionaDuration);

            graphviz
                .engine(selectedEngine)
                .fade(true)
                .transition(transition)
                .tweenPaths(true) // default
                .tweenShapes(true) // default
                .zoomScaleExtent([0, Infinity])
                .zoom(true)
                .renderDot(dotSrc)
                .on("end", function () {
                    // this calls the jquery.graphviz.svg setup() directly,
                    // it is normaly called internaly on object init
                    // we need to call it manualy, bcs. the svg was regenerated by d3-graphviz
                    $('#graph').data('graphviz.svg').setup()  //resetup
                });
        }

        $(document).ready(function () {
            // this inits the graphviz object from jquery.grapviz.svg.js
            $("#graph").graphviz({
                // see jquery.graphviz.svg.js -> GraphvizSvg.DEFAULTS
                // and https://github.com/mountainstorm/jquery.graphviz.svg
                // to see what can be passed in this init-object
                shrink: null,
                zoom: false,
                ready: function () {
                    gv = this

                    gv.nodes().click(function (event) {
                        const set = $();
                        set.push(this);

                        var obj = {
                            set: set,
                            direction: searchObject.direction
                        };

                        // If CMD or CTRL is pressed, then add this to the selection
                        if (event.ctrlKey || event.metaKey || event.shiftKey) {
                            currentSelection.push(obj);
                        } else {
                            currentSelection = [obj];
                        }

                        highlight();
                    })

                    $(document).keydown(function (evt) {
                        // press escape to cancel highlight
                        if (evt.keyCode == 27) {
                            gv.highlight()
                        }
                    })

                }
            });
        });

        var TRange = null;


    </script>
</body>

</html>
