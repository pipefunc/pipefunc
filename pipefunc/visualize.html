<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PipeFunc Graph</title>
    <script src="https://unpkg.com/jquery@3.6.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/jquery-mousewheel@3.1.13/jquery.mousewheel.js"></script>
    <script src="https://unpkg.com/jquery-color@2.2.0/dist/jquery.color.js"></script>
    <script src="https://unpkg.com/d3@7.6.1/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mountainstorm/jquery.graphviz.svg@master/js/jquery.graphviz.svg.js"></script>
    <script src="https://unpkg.com/@hpcc-js/wasm@1.18.0/dist/index.min.js"></script>
    <script src="https://unpkg.com/d3-graphviz@4.4.0/build/d3-graphviz.min.js"></script>
</head>

<body>
    <div id="graph" style="text-align: center;"></div>
    <script>
        // Initialize a d3-graphviz renderer instance
        var graphviz = d3.select("#graph").graphviz();

        // Configuration for transitions in rendering the graph
        var config = {
            transitionDelay: 0,
            transitionDuration: 500
        };

        // Variable for storing the selected graph rendering engine
        var selectedEngine = "dot";

        // Object for saving the current GraphVizSVG
        var graphVizObject;

        // Variable for storing the selected direction for highlighting
        var selectedDirection = "bidirectional";

        // Array holding the current selections
        var currentSelection = [];

        // Function to highlight selected nodes and their connected nodes
        function highlightSelection() {
            let highlightedNodes = $();
            currentSelection.forEach(selection => {
                const nodes = getConnectedNodes(selection.set, selection.direction);
                highlightedNodes = highlightedNodes.add(nodes);
            });
            graphVizObject.highlight(highlightedNodes, true);
        }

        // Function to retrieve nodes connected in the specified direction
        function getConnectedNodes(nodeSet, mode = "bidirectional") {
            let resultSet = $().add(nodeSet);
            if (mode === "bidirectional" || mode === "downstream") {
                nodeSet.each((i, el) => {
                    if (el.className.baseVal === "edge") {
                        const edge = $(el).data("name");
                        const nodes = graphVizObject.nodesByName();
                        const downstreamNode = edge.split("->")[1];
                        if (downstreamNode) {
                            resultSet = resultSet.add(nodes[downstreamNode]);
                            resultSet = resultSet.add(graphVizObject.linkedFrom(nodes[downstreamNode], true));
                        }
                    } else {
                        resultSet = resultSet.add(graphVizObject.linkedFrom(el, true));
                    }
                });
            }
            if (mode === "bidirectional" || mode === "upstream") {
                nodeSet.each((i, el) => {
                    if (el.className.baseVal === "edge") {
                        const edge = $(el).data("name");
                        const nodes = graphVizObject.nodesByName();
                        const upstreamNode = edge.split("->")[0];
                        if (upstreamNode) {
                            resultSet = resultSet.add(nodes[upstreamNode]);
                            resultSet = resultSet.add(graphVizObject.linkedTo(nodes[upstreamNode], true));
                        }
                    } else {
                        resultSet = resultSet.add(graphVizObject.linkedTo(el, true));
                    }
                });
            }
            return resultSet;
        }

        // Function to reset the graph zoom and selection highlights
        function resetGraph() {
            graphviz.resetZoom();
            graphVizObject.highlight(); // Reset node selection on reset
            currentSelection = [];
        }

        // Function to update the graph rendering engine
        function updateEngine(newEngine) {
            selectedEngine = newEngine;
        }

        // Main function to render the graph from DOT source
        function render(dotSource) {
            var transition = d3.transition("graphTransition")
                .ease(d3.easeLinear)
                .delay(config.transitionDelay)
                .duration(config.transitionDuration);  // Using corrected variable name

            graphviz
                .engine(selectedEngine)
                .fade(true)
                .transition(transition)
                .tweenPaths(true)
                .tweenShapes(true)
                .zoomScaleExtent([0, Infinity])
                .zoom(true)
                .renderDot(dotSource)
                .on("end", function () {
                    // Calls the jquery.graphviz.svg setup directly
                    $('#graph').data('graphviz.svg').setup(); // Re-setup after rendering
                });
        }

        // Document ready function
        $(document).ready(function () {
            // Initialize the GraphVizSVG object from jquery.graphviz.svg.js
            $("#graph").graphviz({
                shrink: null,
                zoom: false,
                ready: function () {
                    graphVizObject = this;

                    // Event listener for node clicks to handle selection
                    graphVizObject.nodes().click(function (event) {
                        const nodeSet = $().add(this);
                        const selectionObject = {
                            set: nodeSet,
                            direction: selectedDirection
                        };

                        // If CMD, CTRL, or SHIFT is pressed, add to the selection
                        if (event.ctrlKey || event.metaKey || event.shiftKey) {
                            currentSelection.push(selectionObject);
                        } else {
                            currentSelection = [selectionObject];
                        }

                        highlightSelection();
                    });

                    // Event listener for pressing the escape key to cancel highlights
                    $(document).keydown(function (event) {
                        if (event.keyCode === 27) {
                            graphVizObject.highlight();
                        }
                    });
                }
            });
        });

        // Check if render function is defined and invoke it if true
        if (typeof render === 'function') {
            render(`
digraph {
	graph [bb="0,0,783.73,403",
		rankdir=LR
	];
	node [label="\N",
		shape=rectangle
	];
	subgraph cluster_legend {
		graph [bb="8,312,775.73,395",
			color=black,
			fillcolor=lightgrey,
			fontcolor=black,
			fontsize=20,
			label=Legend,
			lheight=0.31,
			lp="391.86,379.75",
			lwidth=0.82,
			rankdir=LR,
			style=filled
		];
		legend_0	[color=black,
			fillcolor="#90EE90",
			fontname=Helvetica,
			height=0.5,
			label=Argument,
			penwidth=1,
			pos="53.625,338",
			style="filled,dashed",
			width=1.0451];
		legend_1	[color=black,
			fillcolor="#87CEEB",
			fontname=Helvetica,
			height=0.5,
			label=PipeFunc,
			penwidth=1,
			pos="207.23,338",
			shape=box,
			style="rounded,filled",
			width=1.0139];
		legend_0 -> legend_1	[pos="e,170.31,338 91.711,338 112,338 137.34,338 159.02,338",
			style=invis];
		legend_2	[color="#FF0000",
			fillcolor="#87CEEB",
			fontname=Helvetica,
			height=0.5,
			label=NestedPipeFunction,
			penwidth=1,
			pos="391.95,338",
			shape=box,
			style="rounded,filled",
			width=1.9097];
		legend_1 -> legend_2	[pos="e,322.82,338 243.89,338 263.17,338 287.8,338 311.37,338",
			style=invis];
		legend_3	[color=black,
			fillcolor="#FF0000",
			fontname=Helvetica,
			height=0.5,
			label=Bound,
			penwidth=1,
			pos="553.8,338",
			shape=hexagon,
			style=filled,
			width=1.1466];
		legend_2 -> legend_3	[pos="e,511.78,338 460.74,338 474.03,338 487.78,338 500.47,338",
			style=invis];
		legend_4	[color=black,
			fillcolor="#FFA500",
			fontname=Helvetica,
			height=0.5,
			label=Resources,
			penwidth=1,
			pos="707.31,338",
			shape=hexagon,
			style=filled,
			width=1.6782];
		legend_3 -> legend_4	[pos="e,645.93,338 595.8,338 607.85,338 621.4,338 634.77,338",
			style=invis];
	}
	a	[color=black,
		fillcolor="#90EE90",
		fontname=Helvetica,
		height=0.5,
		label=<<b>a</b> : <i>int</i>>,
		margin=0.05,
		penwidth=1,
		pos="53.625,225",
		style="filled,dashed",
		width=0.75];
	"f(...) → c"	[color=black,
		fillcolor="#87CEEB",
		fontname=Helvetica,
		height=1.0236,
		label=<<TABLE BORDER="0"><TR><TD><B>f(...)</B></TD></TR><HR/><TR><TD><b>c</b> : <i>int</i></TD></TR><HR/><TR><TD><FONT FACE="Courier New">... -&gt; c[i]</FONT></TD></TR></TABLE>>,
		margin=0.05,
		penwidth=1,
		pos="207.23,196",
		shape=box,
		style="rounded,filled",
		width=1.4715];
	a -> "f(...) → c"	[color="#90EE90",
		pos="e,153.76,206.04 81.032,219.95 98.08,216.69 121.03,212.3 142.63,208.17"];
	"NestedPipeFunc_i2(...) → i2"	[color="#FF0000",
		fillcolor="#87CEEB",
		fontname=Helvetica,
		height=0.71111,
		label=<<TABLE BORDER="0"><TR><TD><B>NestedPipeFunc_i2(...)</B></TD></TR><HR/><TR><TD><b>i2</b> : <i>dict</i></TD></TR></TABLE>>,
		margin=0.05,
		penwidth=1,
		pos="207.23,276",
		shape=box,
		style="rounded,filled",
		width=2.2215];
	a -> "NestedPipeFunc_i2(...) → i2"	[color="#90EE90",
		pos="e,128.66,249.91 81.032,233.88 91.608,237.44 104.46,241.76 117.84,246.27"];
	b	[color=black,
		fillcolor="#90EE90",
		fontname=Helvetica,
		height=0.5,
		label=<<b>b</b> : <i>int</i>>,
		margin=0.05,
		penwidth=1,
		pos="53.625,166",
		style="filled,dashed",
		width=0.75];
	b -> "f(...) → c"	[color="#90EE90",
		pos="e,153.76,185.62 81.032,171.23 98.08,174.6 121.03,179.14 142.63,183.42"];
	"g(...) → d"	[color=black,
		fillcolor="#87CEEB",
		fontname=Helvetica,
		height=0.71111,
		label=<<TABLE BORDER="0"><TR><TD><B>g(...)</B></TD></TR><HR/><TR><TD><b>d</b> : <i>int</i></TD></TR></TABLE>>,
		margin=0.05,
		penwidth=1,
		pos="391.95,134",
		shape=box,
		style="rounded,filled",
		width=0.75];
	b -> "g(...) → d"	[color="#90EE90",
		pos="e,364.62,134.24 81.005,159.15 94.707,155.85 111.78,152.16 127.25,150 207.15,138.84 301.75,135.46 353.12,134.44"];
	x	[color=black,
		fillcolor="#90EE90",
		fontname=Helvetica,
		height=0.5,
		label=<<b>x</b> : <i>int</i>  = 1>,
		margin=0.05,
		penwidth=1,
		pos="207.23,85",
		style="filled,dashed",
		width=0.93333];
	x -> "g(...) → d"	[color="#90EE90",
		pos="e,364.62,126.94 241.32,93.874 272.96,102.36 320.62,115.14 353.61,123.99"];
	"f(...) → c" -> "g(...) → d"	[color="#87CEEB",
		pos="e,364.7,142.91 260.59,178.23 290.39,168.12 327.01,155.69 353.85,146.59"];
	"h(...) → e"	[color=black,
		fillcolor="#87CEEB",
		fontname=Helvetica,
		height=1.0236,
		label=<<TABLE BORDER="0"><TR><TD><B>h(...)</B></TD></TR><HR/><TR><TD><b>e</b> : <i>int</i></TD></TR><HR/><TR><TD><FONT FACE="Courier New">c[i] -&gt; e[i]</FONT></TD></TR></TABLE>>,
		margin=0.05,
		penwidth=1,
		pos="553.8,103",
		shape=box,
		style="rounded,filled",
		width=1.5861];
	"f(...) → c" -> "h(...) → e"	[color="#0000FF",
		pos="e,510.52,140.24 260.31,198.05 312.65,198.39 394.79,194.12 460.7,169 474.76,163.64 488.64,155.59 501.2,146.94"];
	"g(...) → d" -> "h(...) → e"	[color="#87CEEB",
		pos="e,496.51,113.92 419.35,128.88 437.33,125.39 462.01,120.61 485.25,116.1"];
	"_Bound(name='x', output_name='e')"	[color=black,
		fillcolor="#FF0000",
		fontname=Helvetica,
		height=0.5,
		label=<<b>x</b>>,
		margin=0.05,
		penwidth=1,
		pos="391.95,72",
		shape=hexagon,
		style=filled,
		width=0.75];
	"_Bound(name='x', output_name='e')" -> "h(...) → e"	[color="#FF0000",
		pos="e,496.38,92.059 416.19,76.508 434.37,80.032 460.59,85.118 485.21,89.893"];
	"_Resources(name='resources', output_name='e')"	[color=black,
		fillcolor="#FFA500",
		fontname=Helvetica,
		height=0.5,
		label=<<b>resources</b>>,
		margin=0.05,
		penwidth=1,
		pos="391.95,18",
		shape=hexagon,
		style=filled,
		width=1.4607];
	"_Resources(name='resources', output_name='e')" -> "h(...) → e"	[color="#FFA500",
		pos="e,497.25,65.744 427.26,30.269 438.14,34.529 450.09,39.603 460.7,45 469.51,49.482 478.57,54.555 487.4,59.789"];
}
            `);
        } else {
            console.error('The render function is not defined.');
        }
    </script>
</body>

</html>
