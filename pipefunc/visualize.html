<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Graph</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        svg {
            position: fixed;
            left: 0px;
            height: 100%;
            width: 100%
        }
    </style>

    <script src="dist/jquery.min.js"></script>
    <script src="dist/jquery.mousewheel.js"></script>
    <script src="dist/jquery.color.min.js"></script>
    <script src="graphvizSvg/jquery.graphviz.svg.js"></script>

    <script src="dist/d3.min.js"></script>
    <script src="dist/hpccjswasm.js"></script>
    <script src="dist/d3-graphviz.min.js"></script>

    <script type="module" src="dist/webviewuitoolkit.min.js"></script>
    <script src="./save.js"></script>
    <script src="./search.js"></script>
    <script src="./highlighting.js"></script>
    <link rel="stylesheet" href="dist/codicon.css" />
</head>

<body>
    <div id="graph" style="text-align: center;"></div>
    <script>
        const currentHighlight = $();
        /** graphviz globals **/
        // creates a d3-graphviz renderer instance, not to be confused with jquery.graphviz.svg
        var graphviz = d3.select("#graph").graphviz();
        // object for saving configuration from the extension
        var viewConfig;

        // currently selected graphviz render engine
        var selectedEngine = "dot";

        // Object for saving the current GraphVizSVG Object
        var gv;

        // SearchObject which holds the current Search Settings
        const searchObject = {
            type: "included",
            case: "insensitive",
            direction: "bidirectional",
            nodeName: true,
            nodeLabel: true,
            edgeLabel: true,
            clusterName: true,
            clusterLabel: true,
        }

        // Array with the current Selections
        var currentSelection = [];

        function reset() {
            graphviz.resetZoom();
            gv.highlight(); // reset node selection on reset
            currentSelection = [];
        }

        function changeDirection(newDirection) {
            searchObject.direction = newDirection;
        }

        function changeEngine(newEngine) {
            selectedEngine = newEngine;
        }

        /** main render funcs **/
        function render(dotSrc) {
            transition = d3.transition("startTransition")
                .ease(d3.easeLinear)
                .delay(viewConfig.transitionDelay)
                .duration(viewConfig.transitionaDuration);

            graphviz
                .engine(selectedEngine)
                .fade(true)
                .transition(transition)
                .tweenPaths(true) // default
                .tweenShapes(true) // default
                .zoomScaleExtent([0, Infinity])
                .zoom(true)
                .renderDot(dotSrc)
                .on("end", function () {
                    // this calls the jquery.graphviz.svg setup() directly,
                    // it is normaly called internaly on object init
                    // we need to call it manualy, bcs. the svg was regenerated by d3-graphviz
                    $('#graph').data('graphviz.svg').setup()  //resetup
                });
        }

        $(document).ready(function () {
            // this inits the graphviz object from jquery.grapviz.svg.js
            $("#graph").graphviz({
                // see jquery.graphviz.svg.js -> GraphvizSvg.DEFAULTS
                // and https://github.com/mountainstorm/jquery.graphviz.svg
                // to see what can be passed in this init-object
                shrink: null,
                zoom: false,
                ready: function () {
                    gv = this

                    gv.nodes().click(function (event) {
                        const set = $();
                        set.push(this);

                        var obj = {
                            set: set,
                            direction: searchObject.direction
                        };

                        // If CMD or CTRL is pressed, then add this to the selection
                        if (event.ctrlKey || event.metaKey || event.shiftKey) {
                            currentSelection.push(obj);
                        } else {
                            currentSelection = [obj];
                        }

                        highlight();
                    })

                    $(document).keydown(function (evt) {
                        // press escape to cancel highlight
                        if (evt.keyCode == 27) {
                            gv.highlight()
                        }
                    })

                }
            });
        });

        var TRange = null;


    </script>
</body>

</html>
